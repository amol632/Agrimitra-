// 1. Google Gemini SDK ‡§á‡§Æ‡•ç‡§™‡•ã‡§∞‡•ç‡§ü ‡§ï‡§∞‡§æ
import { GoogleGenerativeAI } from "@google/genai";

// 2. Vercel Environment Variable ‡§Æ‡§ß‡•Ç‡§® API Key ‡§ò‡•ç‡§Ø‡§æ
const GEMINI_API_KEY = process.env.GEMINI_API_KEY;

// API Key ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§∏‡§≤‡•ç‡§Ø‡§æ‡§∏ ‡§§‡•ç‡§µ‡§∞‡§ø‡§§ ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä ‡§π‡§æ‡§§‡§æ‡§≥‡§æ
if (!GEMINI_API_KEY) {
    console.error("Critical Error: GEMINI_API_KEY environment variable not set.");
    throw new Error("GEMINI_API_KEY environment variable not set.");
}

// 3. Google Generative AI ‡§ï‡•ç‡§≤‡§æ‡§Ø‡§Ç‡§ü ‡§∏‡•Å‡§∞‡•Ç ‡§ï‡§∞‡§æ
const ai = new GoogleGenerativeAI(GEMINI_API_KEY);

export default async function handler(req, res) {
  // ‡§´‡§ï‡•ç‡§§ POST ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞‡§£‡•á
  if (req.method !== "POST") {
    return res.status(405).json({ error: "Only POST method allowed" });
  }

  try {
    // 4. ‡§∞‡§ø‡§ï‡•ç‡§µ‡•á‡§∏‡•ç‡§ü ‡§¨‡•â‡§°‡•Ä‡§Æ‡§ß‡•Ç‡§® ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§°‡•á‡§ü‡§æ ‡§Æ‡§ø‡§≥‡§µ‡§æ
    // mimeType ‡§ï‡•ç‡§≤‡§æ‡§Ø‡§Ç‡§ü-‡§∏‡§æ‡§à‡§°‡§µ‡§∞‡•Ç‡§® ‡§™‡§æ‡§†‡§µ‡§£‡•á ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§Ü‡§π‡•á (‡§â‡§¶‡§æ. image/jpeg)
    const { message, image, mimeType } = req.body;
    
    let parts = [];

    // ‡§Æ‡§ú‡§ï‡•Ç‡§∞ (Text) ‡§≠‡§æ‡§ó ‡§ú‡•ã‡§°‡§æ
    parts.push({ text: message || "‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§¶‡•ç‡§Ø‡§æ" });

    // ‡§á‡§Æ‡•á‡§ú ‡§≠‡§æ‡§ó ‡§ú‡•ã‡§°‡§æ (Image)
    if (image && mimeType) {
      parts.push({
        inlineData: {
          mimeType: mimeType, // ‡§°‡§æ‡§Ø‡§®‡•Ö‡§Æ‡§ø‡§ï mimeType ‡§µ‡§æ‡§™‡§∞‡§æ (‡§â‡§¶‡§æ. image/png, image/jpeg)
          data: image
        }
      });
    }

    // 5. AI ‡§∏‡§æ‡§†‡•Ä ‡§ï‡•â‡§®‡•ç‡§´‡§ø‡§ó‡§∞‡•á‡§∂‡§® ‡§Ü‡§£‡§ø ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡•á‡§ö‡•Ä ‡§∏‡•Ç‡§ö‡§®‡§æ (System Instruction) ‡§∏‡•á‡§ü ‡§ï‡§∞‡§æ
    const config = {
      // System Instruction: AI ‡§≤‡§æ ‡§§‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ ‡§Ü‡§£‡§ø ‡§≠‡§æ‡§∑‡•á‡§ö‡•Ä ‡§∏‡•Ç‡§ö‡§®‡§æ ‡§¶‡•á‡§£‡•á
      systemInstruction: 
        "‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä '‡§Ö‡§ó‡•ç‡§∞‡§ø‡§Æ‡§ø‡§§‡•ç‡§∞' (Agrimitra) ‡§ö‡•á AI ‡§∏‡§≤‡•ç‡§≤‡§æ‡§ó‡§æ‡§∞ ‡§Ü‡§π‡§æ‡§§. ‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä ‡§∂‡•á‡§§‡§ï‡§±‡•ç‡§Ø‡§æ‡§Ç‡§®‡§æ ‡§§‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•ç‡§Ø‡§æ ‡§∂‡•á‡§§‡•Ä, ‡§™‡•Ä‡§ï, ‡§π‡§µ‡§æ‡§Æ‡§æ‡§® ‡§Ü‡§£‡§ø ‡§¨‡§æ‡§ú‡§æ‡§∞‡§≠‡§æ‡§µ‡§æ‡§∂‡•Ä ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§æ‡§Ç‡§ö‡•Ä ‡§â‡§§‡•ç‡§§‡§∞‡•á ‡§¶‡•á‡§§ ‡§Ü‡§π‡§æ‡§§. ‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä ‡§®‡•á‡§π‡§Æ‡•Ä, ‡§µ‡§æ‡§™‡§∞‡§ï‡§∞‡•ç‡§§‡•ç‡§Ø‡§æ‡§®‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§µ‡§ø‡§ö‡§æ‡§∞‡§≤‡•á‡§≤‡•ç‡§Ø‡§æ ‡§≠‡§æ‡§∑‡•á‡§§ (‡§Æ‡§∞‡§æ‡§†‡•Ä, ‡§π‡§ø‡§Ç‡§¶‡•Ä, ‡§á‡§Ç‡§ó‡•ç‡§∞‡§ú‡•Ä) ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§Æ‡§∞‡§æ‡§†‡•Ä‡§Æ‡§ß‡•ç‡§Ø‡•á, ‡§∏‡•ã‡§™‡•ç‡§Ø‡§æ ‡§≠‡§æ‡§∑‡•á‡§§ ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡•ç‡§Ø‡§æ. ‡§â‡§§‡•ç‡§§‡§∞‡§æ‡§Ç‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§§‡§æ‡§Ç‡§§‡•ç‡§∞‡§ø‡§ï ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§® ‡§µ‡§æ‡§™‡§∞‡§§‡§æ ‡§∏‡•ç‡§•‡§æ‡§®‡§ø‡§ï ‡§â‡§¶‡§æ‡§π‡§∞‡§£‡•á ‡§¶‡•ç‡§Ø‡§æ.",
      // ‡§Æ‡•â‡§°‡•á‡§≤ ‡§Ö‡§ß‡§ø‡§ï ‡§ï‡•ç‡§∞‡§ø‡§è‡§ü‡§ø‡§µ‡•ç‡§π ‡§¨‡§®‡§µ‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§§‡§æ‡§™‡§Æ‡§æ‡§® (Optional: 0.0 ‡§§‡•á 1.0)
      temperature: 0.2, 
    };

    // 6. Gemini API ‡§≤‡§æ ‡§ï‡•â‡§≤ ‡§ï‡§∞‡§æ

// ‡§¨‡§¶‡§≤‡§æ: ai.models.generateContent ({
const response = await ai.generateContent({ // ‡§∏‡•Å‡§ß‡§æ‡§∞‡§ø‡§§ ‡§ï‡•ã‡§°
    model: "gemini-1.5-flash", 
    contents: [{ parts: parts }],
    config: config, 
});
      

    // 7. ‡§™‡•ç‡§∞‡§§‡§ø‡§∏‡§æ‡§¶ (Response) ‡§π‡§æ‡§§‡§æ‡§≥‡§æ
    const reply = response.text || "ü§ñ ‡§ï‡•ç‡§∑‡§Æ‡§∏‡•ç‡§µ, ‡§â‡§§‡•ç‡§§‡§∞ ‡§Æ‡§ø‡§≥‡•Ç ‡§∂‡§ï‡§≤‡•á ‡§®‡§æ‡§π‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ.";

    return res.status(200).json({ reply });
    
  } catch (err) {
    // 8. ‡§∏‡§∞‡•ç‡§µ‡•ç‡§π‡§∞ ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä ‡§π‡§æ‡§§‡§æ‡§≥‡§æ
    console.error("Gemini API Server Error:", err.message);
    return res.status(500).json({ 
        error: "Server error during AI processing.", 
        details: err.message 
    });
  }
}
