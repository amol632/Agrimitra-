<!DOCTYPE html>
<html lang="mr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AgriMitra ‚Äî Market Prices (Live)</title>
<style>
  body{font-family:Arial, sans-serif;background:linear-gradient(135deg,#ff9a9e,#fecfef);margin:0;padding:20px}
  h1{text-align:center;color:#d63384;margin:0 0 18px}
  .form-container{text-align:center;margin-bottom:18px}
  select{padding:10px;border-radius:8px;border:1px solid #d63384;font-size:16px}
  .cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;margin-top:12px}
  .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 6px 12px rgba(0,0,0,0.12);border-left:6px solid #d63384}
  .card h3{margin:0 0 6px;color:#d63384;font-size:18px}
  .card p{margin:4px 0;color:#333;font-size:14px}
  .info{ text-align:center;color:#555;margin-top:8px }
  .small{font-size:13px;color:#666}
</style>
</head>
<body>
  <h1>AgriMitra ‚Äî ‡§Æ‡§æ‡§∞‡•ç‡§ï‡•á‡§ü ‡§≠‡§æ‡§µ (Live)</h1>

  <div class="form-container">
    <label for="district">‡§ú‡§ø‡§≤‡•ç‡§π‡§æ ‡§®‡§ø‡§µ‡§°‡§æ: </label>
    <select id="district" onchange="getPrices()">
      <option value="">-- ‡§ú‡§ø‡§≤‡•ç‡§π‡§æ ‡§®‡§ø‡§µ‡§°‡§æ --</option>
      <!-- full list of districts (as before) -->
      <option value="Ahmednagar">Ahmednagar</option>
      <option value="Akola">Akola</option>
      <option value="Amravati">Amravati</option>
      <option value="Aurangabad">Aurangabad</option>
      <option value="Beed">Beed</option>
      <option value="Bhandara">Bhandara</option>
      <option value="Buldhana">Buldhana</option>
      <option value="Chandrapur">Chandrapur</option>
      <option value="Dhule">Dhule</option>
      <option value="Gadchiroli">Gadchiroli</option>
      <option value="Gondia">Gondia</option>
      <option value="Hingoli">Hingoli</option>
      <option value="Jalgaon">Jalgaon</option>
      <option value="Jalna">Jalna</option>
      <option value="Kolhapur">Kolhapur</option>
      <option value="Latur">Latur</option>
      <option value="Mumbai">Mumbai</option>
      <option value="Nagpur">Nagpur</option>
      <option value="Nanded">Nanded</option>
      <option value="Nandurbar">Nandurbar</option>
      <option value="Nashik">Nashik</option>
      <option value="Osmanabad">Osmanabad</option>
      <option value="Palghar">Palghar</option>
      <option value="Parbhani">Parbhani</option>
      <option value="Pune">Pune</option>
      <option value="Raigad">Raigad</option>
      <option value="Ratnagiri">Ratnagiri</option>
      <option value="Sangli">Sangli</option>
      <option value="Satara">Satara</option>
      <option value="Sindhudurg">Sindhudurg</option>
      <option value="Solapur">Solapur</option>
      <option value="Thane">Thane</option>
      <option value="Wardha">Wardha</option>
      <option value="Washim">Washim</option>
      <option value="Yavatmal">Yavatmal</option>
    </select>
  </div>

  <div id="info" class="info small">‡§ú‡§ø‡§≤‡•ç‡§π‡§æ ‡§®‡§ø‡§µ‡§°‡§æ ‡§Æ‡•ç‡§π‡§£‡§ú‡•á‡§ö ‡§°‡•á‡§ü‡§æ ‡§Ø‡•á‡§à‡§≤ ‚Äî console ‡§Æ‡§ß‡•ç‡§Ø‡•á debug ‡§¨‡§ò‡§æ.</div>
  <div id="results" class="cards"></div>

<script>
const API_KEY = "579b464db66ec23bdd0000019f0ca214d5c34d7476b4ffb1b25324e1";
const RESOURCE_ID = "35985678-0d79-46b4-9ed6-6f13308a1d24";
const BASE_URL = `https://api.data.gov.in/resource/${RESOURCE_ID}`;

/*
 Helper: normalize object keys to lowercase_underscore form,
 and return value by standard name or 'N/A' if missing.
*/
function normalizeRecord(rec){
  const norm = {};
  for(const k in rec){
    if(!Object.prototype.hasOwnProperty.call(rec,k)) continue;
    const cleanK = k.trim().toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'');
    norm[cleanK] = rec[k];
  }
  return {
    commodity: norm.commodity || norm.commodity_name || norm.commoditytype || norm['commodity name'] || 'N/A',
    variety: norm.variety || norm.variety_name || 'N/A',
    market: norm.market || norm.market_name || norm['market_name'] || 'N/A',
    district: norm.district || norm.district_name || 'N/A',
    min_price: norm.min_price || norm.min_price_rs || norm.minprice || norm['min_price_rs'] || 'N/A',
    max_price: norm.max_price || norm.max_price_rs || norm.maxprice || 'N/A',
    modal_price: norm.modal_price || norm.modalprice || norm.modal || norm['modal_price_rs'] || 'N/A',
    arrival_date: norm.arrival_date || norm.arrivaldate || norm.date || 'N/A',
    raw: rec
  };
}

function clearResults(){
  document.getElementById('results').innerHTML = '';
  document.getElementById('info').innerText = '‡§≤‡•ã‡§° ‡§ï‡§∞‡§§ ‡§Ü‡§π‡•á...';
}

function showError(msg){
  document.getElementById('results').innerHTML = `<div style="grid-column:1/-1;text-align:center;color:#8b0000">${msg}</div>`;
  document.getElementById('info').innerText = '';
}

async function getPrices(){
  const districtSelect = document.getElementById('district');
  const district = districtSelect.value;
  const resDiv = document.getElementById('results');
  if(!district){
    showError('‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§•‡§Æ ‡§ú‡§ø‡§≤‡•ç‡§π‡§æ ‡§®‡§ø‡§µ‡§°‡§æ');
    return;
  }

  clearResults();
  // build url: increase limit to 500 to fetch more records (server may ignore very large)
  const url = `${BASE_URL}?api-key=${API_KEY}&format=json&limit=500&filters[state]=Maharashtra&filters[district]=${encodeURIComponent(district)}`;
  console.log('Fetching:', url);

  try{
    const resp = await fetch(url);
    if(!resp.ok){
      throw new Error(`HTTP ${resp.status} ${resp.statusText}`);
    }
    const data = await resp.json();
    console.log('Raw API response:', data);
    const recs = Array.isArray(data.records) ? data.records : [];
    console.log('records.length =', recs.length, recs[0] || '(no first record)');

    document.getElementById('info').innerText = `‡§Æ‡§ø‡§≥‡§æ‡§≤‡•á‡§≤‡•á ‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§°‡•ç‡§∏: ${recs.length}`;

    if(recs.length === 0){
      showError('‡§°‡§æ‡§ü‡§æ ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä üö´ (API ‡§ï‡§°‡•Ç‡§® ‡§∞‡§ø‡§ï‡§æ‡§Æ‡§æ response)');
      return;
    }

    // Normalize and render cards
    resDiv.innerHTML = '';
    recs.forEach(r => {
      const item = normalizeRecord(r);
      // create card html (use N/A fallback)
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <h3>${escapeHtml(item.commodity)} ${item.variety !== 'N/A' ? `(${escapeHtml(item.variety)})` : ''}</h3>
        <p><b>‡§¨‡§æ‡§ú‡§æ‡§∞:</b> ${escapeHtml(item.market)}</p>
        <p><b>‡§ï‡§ø‡§Æ‡§æ‡§® ‡§≠‡§æ‡§µ:</b> ‚Çπ ${escapeHtml(item.min_price)}</p>
        <p><b>‡§ï‡§Æ‡§æ‡§≤ ‡§≠‡§æ‡§µ:</b> ‚Çπ ${escapeHtml(item.max_price)}</p>
        <p><b>‡§∏‡§∞‡§æ‡§∏‡§∞‡•Ä / modal:</b> ‚Çπ ${escapeHtml(item.modal_price)}</p>
        <p class="small"><b>‡§§‡§æ‡§∞‡•Ä‡§ñ:</b> ${escapeHtml(item.arrival_date)}</p>
      `;
      resDiv.appendChild(card);
    });

  } catch(err){
    console.error('Fetch error:', err);
    showError('API ‡§ï‡•â‡§≤ ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä ‡§Ü‡§≤‡•Ä ‚Äî console ‡§™‡§æ‡§π‡§æ.');
  }
}

// small helper to avoid HTML injection
function escapeHtml(str){
  if(str === null || str === undefined) return 'N/A';
  return String(str).replace(/[&<>"'`]/g, s => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'
  })[s]);
}

/* Auto-load if user selects already */
document.getElementById('district').addEventListener('change', getPrices);

// Optional: auto-select user's district based on geolocation? (we can add later)

</script>
</body>
</html>
